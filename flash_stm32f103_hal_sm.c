/**
* \version 1.0
* \author bazhen.levkovets
* \date 2019 
*************************************************************************************
* \copyright	Bazhen Levkovets
* \copyright	Brovary
* \copyright	Ukraine
*************************************************************************************
*/

/*
**************************************************************************
*							INCLUDE FILES
**************************************************************************
*/
	#include "flash_stm32f103_hal_sm.h"
/*
**************************************************************************
*							LOCAL DEFINES
**************************************************************************
*/

/*
**************************************************************************
*							LOCAL CONSTANTS
**************************************************************************
*/

/*
**************************************************************************
*						    LOCAL DATA TYPES
**************************************************************************
*/

/*
**************************************************************************
*							  LOCAL TABLES
**************************************************************************
*/

/*
**************************************************************************
*								 MACRO'S
**************************************************************************
*/

/*
**************************************************************************
*						 LOCAL GLOBAL VARIABLES
**************************************************************************
*/

/*
**************************************************************************
*                        LOCAL FUNCTION PROTOTYPES
**************************************************************************
*/
	uint8_t Flash_Ready( void ) ;
/*
**************************************************************************
*                           GLOBAL FUNCTIONS
**************************************************************************
*/

uint32_t Flash_Read(uint32_t address) {
  return (*(__IO uint32_t*) address ) ;
}
/**********************************************************************/

uint8_t Flash_Ready(void) {
  return !(FLASH->SR & FLASH_SR_BSY);
  // but read next
  // https://habr.com/ru/post/213771/
}
/**********************************************************************/

void Flash_Erase_All_Pages(void) {
  FLASH->CR |= FLASH_CR_MER	;
  FLASH->CR |= FLASH_CR_STRT;
  while(!Flash_Ready())
    ;
  FLASH->CR &= FLASH_CR_MER	;
}
/**********************************************************************/

void Flash_Erase_Page(uint32_t address) {
  FLASH->CR|= FLASH_CR_PER	;
  FLASH->AR = address		;
  FLASH->CR|= FLASH_CR_STRT ;
  while(!Flash_Ready())
    ;
  FLASH->CR&= ~FLASH_CR_PER	;
}
/**********************************************************************/

void Flash_Write(uint32_t address,uint32_t data) {
  FLASH->CR |= FLASH_CR_PG;
  while(!Flash_Ready())
    ;
//  *(__IO uint16_t*)address = (uint16_t)data; //ГђЕёГђВёГ‘Л†ГђВµГђВј ГђВјГђВ»ГђВ°ГђВґГ‘Л†ГђВёГђВµ 2 ГђВ±ГђВ°Г‘вЂљГђВ°
//  while(!Flash_Ready())
//    ;
//  address+=2;
//  data>>=16;
//  *(__IO uint16_t*)address = (uint16_t)data; //ГђЕёГђВёГ‘Л†ГђВµГђВј Г‘пїЅГ‘вЂљГђВ°Г‘в‚¬Г‘Л†ГђВёГђВµ 2 ГђВ±ГђВ°ГђВ№Г‘вЂљГђВ°

  HAL_FLASH_Program(FLASH_TYPEPROGRAM_WORD, address, (uint64_t)data);

  while(!Flash_Ready())
    ;
  FLASH->CR &= ~(FLASH_CR_PG);
}

/*
**************************************************************************
*                           LOCAL FUNCTIONS
**************************************************************************
*/
